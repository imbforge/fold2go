
executor {
    name      = 'slurm'
    jobName   = { task.process.split(':').last() }
}

process {
    errorStrategy = 'retry'
    maxRetries    = 3
    shell         = ['/usr/bin/env', 'bash', '-ue', '-o', 'pipefail']
    cache         = 'lenient' // workaround for lagging nfs timestamps

    // queue = { task.time <= 5.h ? 'short' : 'long' } // NB: this should be the default to avoid blocking gpu nodes with cpu-only jobs, however lack of a fast shared filesystem is prohibitive for msas
    queue = { task.time <= 5.h ? 'gpushort' : 'gpulong' }

    withLabel: cuda {
        clusterOptions = '--gres=gpu:1'
        containerOptions = '--nv --nvccli --writable-tmpfs'
    }

}

singularity {
    enabled      = true
    envWhitelist = "NVIDIA_VISIBLE_DEVICES=1,TF_FORCE_UNIFIED_MEMORY=1,XLA_PYTHON_CLIENT_MEM_FRACTION=4.0"
}

